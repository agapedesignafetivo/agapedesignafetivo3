<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ULTIMO TESTE</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: sans-serif;
    }
    #video, #overlay {
      position: absolute;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }
    #overlay { pointer-events: none; }

    #buttons {
      position: absolute;
      bottom: 40px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 10;
    }

    button {
      height: 60px;
      border-radius: 12px;
      border: none;
      background: #4CAF50;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      padding: 0 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    #recording-indicator {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 12;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      display: none;
    }

    #loading-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: bold;
      text-align: center;
      max-width: 80%;
      display: none;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <img id="overlay" src="moldura.png" alt="Moldura" />

  <div id="recording-indicator">üî¥ REC 00:00</div>
  <div id="loading-message">Aguarde‚Ä¶ estamos processando seu video ‚è≥ div>

  <div id="buttons">
  <button id="switchBtn">üîÑ Trocar C√¢mera</button>
  <button id="snapBtn">üì∏ Tirar Foto</button>
  <button id="recordBtn">üé• Gravar V√≠deo</button>
  <button id="stopBtn" style="display:none;">‚èπÔ∏è Parar Grava√ß√£o</button>
</div>

  <canvas id="canvas" style="display:none;"></canvas>
  <canvas id="recordingCanvas" style="display:none;"></canvas>

  <script>
    const API_URL = "https://videos-molduras-production-00e9.up.railway.app/convert";
    
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture');
    const switchCameraBtn = document.getElementById('switch-camera');
    const startRecordBtn = document.getElementById('start-recording');
    const stopRecordBtn = document.getElementById('stop-recording');
    const recordingIndicator = document.getElementById('recording-indicator');
    const recordingCanvas = document.getElementById('recordingCanvas');
    const loadingMessage = document.getElementById('loading-message');

    let stream, usingFrontCamera = true;
    let mediaRecorder = null, recordedChunks = [], isRecording = false;
    let recordStartTime = 0, recordTimerInterval = null;
    const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    async function startCamera() {
      if(stream) stream.getTracks().forEach(t=>t.stop());
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: usingFrontCamera ? 'user':'environment', width:720, height:1280 },
        audio:true
      });
      video.srcObject = stream;
      video.style.transform = usingFrontCamera ? 'scaleX(-1)':'scaleX(1)';
    }

    switchCameraBtn.onclick = () => {
      usingFrontCamera = !usingFrontCamera;
      startCamera();
    };

    function startRecordingTimer() {
      recordStartTime = Date.now();
      recordingIndicator.style.display = 'block';
      recordTimerInterval = setInterval(()=>{
        const diff = Math.floor((Date.now()-recordStartTime)/1000);
        const m = String(Math.floor(diff/60)).padStart(2,'0');
        const s = String(diff%60).padStart(2,'0');
        recordingIndicator.textContent = `üî¥ REC ${m}:${s}`;
      },500);
    }

    function stopRecordingTimer() {
      clearInterval(recordTimerInterval);
      recordingIndicator.style.display = 'none';
    }

    captureBtn.onclick = () => {
      const ctx = canvas.getContext('2d');
      canvas.width = 720; canvas.height = 1280;
      if(usingFrontCamera){ ctx.translate(720,0); ctx.scale(-1,1); }
      ctx.drawImage(video,0,0,720,1280);
      ctx.setTransform(1,0,0,1,0,0);
      ctx.drawImage(overlay,0,0,720,1280);
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'moldurapersonalizada.png';
      a.click();
    };

    startRecordBtn.onclick = () => {
      if(!stream || isRecording) return;
      const ctx = recordingCanvas.getContext('2d');
      recordingCanvas.width = 720;
      recordingCanvas.height = 1280;
      recordedChunks = [];
      isRecording = true;
      startRecordingTimer();
      startRecordBtn.style.display='none';
      stopRecordBtn.style.display='inline-block';

      function drawFrame() {
        if(!isRecording) return;
        ctx.clearRect(0,0,720,1280);
        if(usingFrontCamera){ ctx.save(); ctx.translate(720,0); ctx.scale(-1,1); ctx.drawImage(video,0,0,720,1280); ctx.restore(); }
        else ctx.drawImage(video,0,0,720,1280);
        ctx.drawImage(overlay,0,0,720,1280);
        requestAnimationFrame(drawFrame);
      }
      drawFrame();

      const canvasStream = recordingCanvas.captureStream(24);
      const combinedStream = new MediaStream();
      canvasStream.getVideoTracks().forEach(t=>combinedStream.addTrack(t));
      stream.getAudioTracks().forEach(t=>combinedStream.addTrack(t));

      mediaRecorder = new MediaRecorder(combinedStream, { mimeType:'video/webm' });
      mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = async ()=>{
        isRecording=false;
        stopRecordingTimer();
        loadingMessage.style.display='block';
        const blob = new Blob(recordedChunks,{ type:'video/webm' });
        const formData = new FormData();
        formData.append('video', blob, 'video.webm');
        try {
          const device = isiOS?'ios':'android';
          const res = await fetch(`${API_URL}?device=${device}`,{ method:'POST', body:formData });
          const mp4 = await res.blob();
          const url = URL.createObjectURL(mp4);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'video-moldura.mp4';
          a.click();
          URL.revokeObjectURL(url);
        } catch(e){ alert('Erro ao processar v√≠deo.'); console.error(e); }
        loadingMessage.style.display='none';
        startRecordBtn.style.display='inline-block';
        stopRecordBtn.style.display='none';
      };
      mediaRecorder.start(100);
    };

    stopRecordBtn.onclick = () => {
      if(mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop();
    };

    startCamera();
  </script>
</body>
</html>
