<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Feito por Criis</title>
<style>
html, body {
  margin:0; padding:0; overflow:hidden;
  background:black; height:100%; width:100%;
}
#camera-wrap {
  position:fixed; inset:0; width:100vw; height:100vh; overflow:hidden; background:black;
}
video {
  position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:black;
}
#frame {
  position:absolute; inset:0; width:100%; height:100%; pointer-events:none;
}
#buttons {
  position:fixed; bottom:25px; width:100%;
  display:flex; justify-content:center; gap:15px; z-index:20;
}
button {
  padding:6px 12px; border:3px solid #74a14a; border-radius:12px;
  font-size:14px; font-weight:bold; background:#ffffff; cursor:pointer;
}
#download { display:none; }
#recordingIndicator {
  position:fixed; top:20px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.7); color:#fff; padding:6px 14px; font-size:16px;
  font-weight:bold; border-radius:20px; display:none; z-index:30;
}
</style>
</head>
<body>

<div id="camera-wrap">
  <video id="video" autoplay playsinline muted></video>
  <img id="frame" src="moldura.png">
</div>

<div id="recordingIndicator">üî¥ REC 00:00</div>

<div id="buttons">
  <button id="switchBtn">üîÑ Trocar C√¢mera</button>
  <button id="snapBtn">üì∏ Tirar Foto</button>
  <button id="recordBtn">üé• Gravar V√≠deo</button>
  <button id="stopBtn" style="display:none;">‚èπÔ∏è Parar Grava√ß√£o</button>
</div>

<a id="download" download="foto-evento.png"></a>
<canvas id="recordCanvas" style="display:none;"></canvas>

<script>
const video=document.getElementById("video");
const frame=document.getElementById("frame");
const snapBtn=document.getElementById("snapBtn");
const switchBtn=document.getElementById("switchBtn");
const download=document.getElementById("download");
const recordBtn=document.getElementById("recordBtn");
const stopBtn=document.getElementById("stopBtn");
const recordCanvas=document.getElementById("recordCanvas");
const recordingIndicator=document.getElementById("recordingIndicator");

let stream=null, usingFront=true, mediaRecorder=null, recordedChunks=[], isRecording=false, recordStartTime=0, recordTimerInterval=null;
const API_URL="https://videos-molduras-production-00e9.up.railway.app/convert";
const isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode: usingFront?"user":"environment" }, audio:true });
  video.srcObject=stream;
  video.style.transform=usingFront?"scaleX(-1)":"scaleX(1)";
  await waitForVideoReady();
}
function waitForVideoReady(){
  return new Promise(resolve=>{
    if(video.readyState>=2 && video.videoWidth>0) resolve();
    else video.onloadedmetadata=()=>resolve();
  });
}

switchBtn.onclick=()=>{ usingFront=!usingFront; startCamera(); }

snapBtn.onclick=async()=>{
  await waitForVideoReady();
  const targetW=720, targetH=1280, canvas=document.createElement("canvas");
  canvas.width=targetW; canvas.height=targetH;
  const ctx=canvas.getContext("2d");
  const vw=video.videoWidth, vh=video.videoHeight;
  const videoRatio=vw/vh, targetRatio=targetW/targetH;
  let sx, sy, sw, sh;
  if(videoRatio>targetRatio){ sh=vh; sw=sh*targetRatio; sx=(vw-sw)/2; sy=0; }
  else{ sw=vw; sh=sw/targetRatio; sx=0; sy=(vh-sh)/2; }
  ctx.save();
  if(usingFront){ ctx.translate(targetW,0); ctx.scale(-1,1); }
  ctx.drawImage(video,sx,sy,sw,sh,0,0,targetW,targetH);
  ctx.restore();
  ctx.drawImage(frame,0,0,targetW,targetH);
  download.href=canvas.toDataURL("image/png"); download.click();
}

function startTimer(){
  recordStartTime=Date.now();
  recordingIndicator.style.display="block";
  recordTimerInterval=setInterval(()=>{
    const diff=Math.floor((Date.now()-recordStartTime)/1000);
    const m=String(Math.floor(diff/60)).padStart(2,"0");
    const s=String(diff%60).padStart(2,"0");
    recordingIndicator.textContent=`üî¥ REC ${m}:${s}`;
  },500);
}
function stopTimer(){ clearInterval(recordTimerInterval); recordingIndicator.style.display="none"; }

recordBtn.onclick=async()=>{
  if(isRecording) return;
  isRecording=true; recordedChunks=[];
  await waitForVideoReady();
  const targetW=720, targetH=1280;
  recordCanvas.width=targetW; recordCanvas.height=targetH;
  const ctx=recordCanvas.getContext("2d");
  function draw(){
    if(!isRecording) return;
    ctx.clearRect(0,0,targetW,targetH);
    ctx.save(); if(usingFront){ ctx.translate(targetW,0); ctx.scale(-1,1); }
    ctx.drawImage(video,0,0,targetW,targetH); ctx.restore();
    ctx.drawImage(frame,0,0,targetW,targetH);
    requestAnimationFrame(draw);
  }
  draw();
  const canvasStream=recordCanvas.captureStream(24);
  const audioTrack=stream.getAudioTracks()[0];
  const combined=new MediaStream();
  canvasStream.getVideoTracks().forEach(t=>combined.addTrack(t));
  if(audioTrack) combined.addTrack(audioTrack);
  mediaRecorder=new MediaRecorder(combined,{ mimeType:"video/webm" });
  mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); }
  mediaRecorder.onstop=async()=>{
    isRecording=false; stopTimer();
    const blob=new Blob(recordedChunks,{ type:"video/webm" });
    const fd=new FormData(); fd.append("video",blob,"video.webm");
    try{
      const device=isiOS?"ios":"android";
      const res=await fetch(`${API_URL}?device=${device}`,{ method:"POST", body:fd });
      const mp4=await res.blob();
      const url=URL.createObjectURL(mp4);
      const a=document.createElement("a"); a.href=url; a.download="video-moldura.mp4"; a.click();
      URL.revokeObjectURL(url);
    }catch(err){ console.error("Erro na convers√£o:",err); alert("Erro ao converter v√≠deo."); }
  }
  mediaRecorder.start(100); startTimer();
  recordBtn.style.display="none"; stopBtn.style.display="inline-block";
}

stopBtn.onclick=()=>{
  if(mediaRecorder && mediaRecorder.state==="recording"){ isRecording=false; mediaRecorder.stop(); }
  recordBtn.style.display="inline-block"; stopBtn.style.display="none";
}

startCamera();
</script>
</body>
</html>
