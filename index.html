<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Teste2</title>

<style>
  html, body {
    margin:0;
    padding:0;
    overflow:hidden;
    background:black;
    height:100%;
    width:100%;
  }

  #camera-wrap {
    position:fixed;
    inset:0;
    width:100vw;
    height:100vh;
    overflow:hidden;
    background:black;
  }

  video {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    background:black;
  }

  #frame {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
  }

  #buttons {
    position:fixed;
    bottom:25px;
    width:100%;
    display:flex;
    justify-content:center;
    gap:20px;
    z-index:20;
  }

  button {
    padding:6px 12px;
    border:3px solid #74a14a; /* Borda verde */
    border-radius:12px;
    font-size:14px;
    font-weight:bold;
    background:#ffffff;
    cursor:pointer;
  }

  #download { display:none; }

  /* üëá Indicador REC */
  #recordingIndicator {
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.7);
    color:#fff;
    padding:6px 14px;
    font-size:16px;
    font-weight:bold;
    border-radius:20px;
    display:none;
    z-index:30;
  }
</style>
</head>
<body>

<div id="camera-wrap">
  <video id="video" autoplay playsinline muted></video>
  <img id="frame" src="moldura.png">
</div>

<div id="recordingIndicator">üî¥ REC 00:00</div>

<div id="buttons">
  <button id="switchBtn">üîÑ Trocar C√¢mera</button>
  <button id="snapBtn">üì∏ Tirar Foto</button>
  <button id="recordBtn">üé• Gravar V√≠deo</button>
  <button id="stopBtn" style="display:none;">‚èπÔ∏è Parar Grava√ß√£o</button>
</div>

<a id="download" download="foto-evento.png"></a>

<!-- Canvas para grava√ß√£o -->
<canvas id="recordCanvas" style="display:none;"></canvas>

<script>
/* ---------------------
   ELEMENTOS
---------------------- */
const video = document.getElementById("video");
const frame = document.getElementById("frame");
const snapBtn = document.getElementById("snapBtn");
const switchBtn = document.getElementById("switchBtn");
const download = document.getElementById("download");

const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const recordCanvas = document.getElementById("recordCanvas");
const recordingIndicator = document.getElementById("recordingIndicator");

/* ---------------------
   VARI√ÅVEIS
---------------------- */
let stream = null;
let usingFront = true;

let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;

let recordStartTime = 0;
let recordTimerInterval = null;

const API_URL = "https://videos-molduras-production-00e9.up.railway.app/convert";
const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ---------------------
   INICIAR C√ÇMERA
---------------------- */
async function startCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }

  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode: usingFront ? "user" : "environment" },
    audio:true
  });

  video.srcObject = stream;
  video.style.transform = usingFront ? "scaleX(-1)" : "scaleX(1)";
  await waitForVideoReady();
}

function waitForVideoReady(){
  return new Promise(resolve=>{
    if(video.readyState >= 2 && video.videoWidth > 0){
      resolve();
      return;
    }
    video.onloadedmetadata = ()=>resolve();
  });
}

switchBtn.onclick = () => {
  usingFront = !usingFront;
  startCamera();
};

/* ---------------------
   FOTO (1080x1920)
---------------------- */
snapBtn.onclick = async () => {
  await waitForVideoReady();

  const targetW = 1080;
  const targetH = 1920;

  const canvas = document.createElement("canvas");
  canvas.width = targetW;
  canvas.height = targetH;
  const ctx = canvas.getContext("2d");

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  // Ajuste proporcional do v√≠deo para preencher o canvas
  const videoRatio = vw / vh;
  const targetRatio = targetW / targetH;

  let sx, sy, sw, sh;
  if(videoRatio > targetRatio){
    sh = vh;
    sw = sh * targetRatio;
    sx = (vw - sw) / 2;
    sy = 0;
  } else {
    sw = vw;
    sh = sw / targetRatio;
    sx = 0;
    sy = (vh - sh) / 2;
  }

  ctx.save();
  if(usingFront){
    ctx.translate(targetW,0);
    ctx.scale(-1,1);
  }

  ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
  ctx.restore();

  // Moldura
  ctx.drawImage(frame,0,0,targetW,targetH);

  download.href = canvas.toDataURL("image/png");
  download.click();
};

/* ---------------------
   TIMER REC
---------------------- */
function startTimer(){
  recordStartTime = Date.now();
  recordingIndicator.style.display = "block";

  recordTimerInterval = setInterval(()=>{
    const diff = Math.floor((Date.now() - recordStartTime) / 1000);
    const m = String(Math.floor(diff / 60)).padStart(2,"0");
    const s = String(diff % 60).padStart(2,"0");
    recordingIndicator.textContent = `üî¥ REC ${m}:${s}`;
  },500);
